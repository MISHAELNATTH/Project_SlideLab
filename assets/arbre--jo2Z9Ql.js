import"./modulepreload-polyfill-B5Qt9EMX.js";const i={nodesLayer:document.getElementById("nodes-layer"),svgLayer:document.getElementById("svg-layer"),sidebarContent:document.getElementById("properties-content"),sidebarSubtitle:document.getElementById("sidebar-subtitle"),canvasEl:document.getElementById("canvas"),btnAdd:document.getElementById("btnAdd"),btnSave:document.getElementById("btnSave"),btnLoad:document.getElementById("btnLoad")};function R(){const{nodesLayer:e,svgLayer:t,sidebarContent:n,sidebarSubtitle:l,canvasEl:r}=i;if(!e||!t||!n||!l||!r)throw new Error("DOM manquant : nodes-layer/svg-layer/properties-content/sidebar-subtitle/canvas")}const s={slides_state:null,nodes:[],selectedNodeId:null,isDragging:!1,dragOffset:{x:0,y:0},draggedNodeId:null},O="slides_state";function B(){const e=localStorage.getItem(O);if(!e)return null;try{return JSON.parse(e)}catch(t){return console.error("slides_state invalide dans localStorage (JSON parse):",t),null}}function M(e){try{localStorage.setItem(O,JSON.stringify(e)),console.log("✓ slides_state sauvegardé")}catch(t){console.error("Erreur save localStorage:",t)}}function D(e,t=200){let n=null;return(...l)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...l),t)}}const k=D(()=>{s.slides_state&&M(s.slides_state)},200);function Y(e){return String(e+1)}function X(e){if(typeof e!="string"||!/^\d+$/.test(e))return null;const t=Number(e);return!Number.isFinite(t)||t<=0?null:t-1}function N(){S(),_()}function S(){i.nodesLayer.innerHTML="",s.nodes.forEach(e=>{const t=e.id===s.selectedNodeId,n=document.createElement("div");n.className=`node ${t?"selected":""}`,n.style.left=`${e.x}px`,n.style.top=`${e.y}px`;const l=e.outputs.length;n.style.height=`${Math.max(80,l*40+40)}px`,n.addEventListener("mousedown",c=>{window.__ARBRE_START_DRAG__?.(c,e.id)});const r=document.createElement("div");r.className="node-title",r.innerText=e.label,n.appendChild(r);const d=Math.max(80,l*40+40),m=l>0?d/(l+1):d;e.outputs.forEach((c,f)=>{const a=document.createElement("div");a.className=`port ${c.link?"connected":""}`,a.style.top=`${m*(f+1)-6}px`,a.title=c.link?`${c.name} → slide_${c.link}`:"Non connecté",n.appendChild(a)}),i.nodesLayer.appendChild(n)})}function _(){i.svgLayer.innerHTML="",s.nodes.forEach(e=>{const t=e.outputs.length,n=Math.max(80,t*40+40),l=t>0?n/(t+1):n;e.outputs.forEach((r,d)=>{if(!r.link)return;const m=X(r.link);if(m==null)return;const c=s.nodes.find($=>$.slideIndex===m);if(!c)return;const f=e.x+192,a=e.y+l*(d+1),g=c.x,y=c.y+Math.max(80,c.outputs.length*40+40)/2,E=f+120,b=g-120,p=`M ${f} ${a} C ${E} ${a}, ${b} ${y}, ${g} ${y}`,x=document.createElementNS("http://www.w3.org/2000/svg","path");x.setAttribute("d",p),x.setAttribute("class",`connection-line ${s.selectedNodeId===e.id?"active":""}`),i.svgLayer.appendChild(x);const u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("class","connection-label");const C=(f+g)/2,L=(a+y)/2-8;u.setAttribute("x",String(C)),u.setAttribute("y",String(L)),u.setAttribute("text-anchor","middle"),u.textContent=`${r.name} -> slide_${m+1}`,i.svgLayer.appendChild(u)})})}function z(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function P(e,t){const n=s.slides_state?.slides?.[e];n&&(n.arbre||(n.arbre={}),n.arbre.title=t,k())}function G(e,t,n){const l=s.slides_state?.slides?.[e];l&&(l.arbre||(l.arbre={}),l.arbre.pos||(l.arbre.pos={x:0,y:0}),l.arbre.pos.x=t,l.arbre.pos.y=n,k())}function I(e,t,n){const l=s.slides_state?.slides?.[e];if(!l||!Array.isArray(l.elements))return;const r=l.elements[t];r&&(r.link=n,k())}function H(e,t){const n=t+1;e?.slides?.length&&e.slides.forEach(l=>{Array.isArray(l.elements)&&l.elements.forEach(r=>{if(!r||r.link==null)return;const d=parseInt(r.link,10);if(!Number.isFinite(d)||d<=0){r.link=null;return}d===n?r.link=null:d>n&&(r.link=String(d-1))})})}function J(e){s.slides_state?.slides?.length&&(s.slides_state.slides.splice(e,1),H(s.slides_state,e),M(s.slides_state),s.selectedNodeId=null,T())}function j(){s.slides_state||(s.slides_state={activeSlide:0,slides:[]}),Array.isArray(s.slides_state.slides)||(s.slides_state.slides=[]);const e=s.slides_state.slides.length;s.slides_state.slides.push({id:z(),backgroundColor:"#ffffff",backgroundGradient:"",elements:[],arbre:{title:`Slide ${e+1}`,pos:{x:100+e*260,y:120+e%4*160}}}),k(),T()}function w(){if(!s.selectedNodeId){i.sidebarSubtitle.innerText="Aucune sélection",i.sidebarContent.innerHTML=`
      <div class="sidebar-empty">
        <p>Sélectionnez une slide (rectangle) pour configurer ses éléments.</p>
      </div>`;return}const e=s.nodes.find(a=>a.id===s.selectedNodeId);if(!e)return;i.sidebarSubtitle.innerText=`Édition de ${e.label}`,i.sidebarContent.innerHTML="";const t=document.createElement("div");t.className="form-group";const n=document.createElement("label");n.className="form-label",n.textContent="Nom de la Slide";const l=document.createElement("input");l.type="text",l.value=e.label,l.className="form-input",l.addEventListener("input",()=>{e.label=l.value,P(e.slideIndex,e.label),S(),_()}),t.appendChild(n),t.appendChild(l),i.sidebarContent.appendChild(t);const r=document.createElement("div");r.className="form-group";const d=document.createElement("button");d.className="btn danger",d.type="button",d.textContent="Supprimer cette slide",d.addEventListener("click",()=>{confirm(`Supprimer "${e.label}" ?
Cette action est irréversible.`)&&J(e.slideIndex)}),r.appendChild(d),i.sidebarContent.appendChild(r);const m=document.createElement("hr");m.className="separator",i.sidebarContent.appendChild(m);const c=document.createElement("h3");if(c.className="section-title",c.innerText="Connexions des éléments",i.sidebarContent.appendChild(c),e.outputs.length===0){const a=document.createElement("p");a.style.color="var(--color-text-muted)",a.style.fontStyle="italic",a.style.fontSize="14px",a.innerText="Cette slide n’a aucun élément dans arbre.elements.",i.sidebarContent.appendChild(a);return}const f=document.createElement("div");f.className="connection-list",e.outputs.forEach(a=>{const g=document.createElement("div");g.className="connection-item";const y=document.createElement("div");y.className="connection-header";const E=document.createElement("span");E.className="connection-label",E.textContent=a.name;const b=document.createElement("div");b.className=`status-dot ${a.link?"active":""}`,y.appendChild(E),y.appendChild(b);const p=document.createElement("select");p.className="select-input";const x=document.createElement("div");x.style.marginTop="8px",x.style.display="none";const u=document.createElement("input");u.type="text",u.className="form-input",u.placeholder="https://... ou texte libre",x.appendChild(u);const C=document.createElement("option");C.value="",C.textContent="-- Non connecté --",p.appendChild(C);const L=document.createElement("option");L.value="__external__",L.textContent="Lien externe",p.appendChild(L);const $=typeof a.link=="string"&&/^\d+$/.test(a.link);a.link&&!$&&(p.value="__external__",x.style.display="block",u.value=a.link),s.nodes.forEach(v=>{if(v.slideIndex===e.slideIndex)return;const h=document.createElement("option");h.value=Y(v.slideIndex),h.textContent=`Vers: slide_${v.slideIndex+1} (${v.label})`,a.link===h.value&&(h.selected=!0),p.appendChild(h)}),p.addEventListener("change",()=>{if(p.value===""){x.style.display="none",a.link=null,b.className="status-dot",I(e.slideIndex,a.elementIndex,null),S(),_();return}if(p.value==="__external__"){x.style.display="block";const h=typeof a.link=="string"&&!/^\d+$/.test(a.link)?a.link:"";u.value=h,a.link=h||null,b.className=`status-dot ${a.link?"active":""}`,I(e.slideIndex,a.elementIndex,a.link),S(),_();return}x.style.display="none";const v=p.value;a.link=v,b.className="status-dot active",I(e.slideIndex,a.elementIndex,v),S(),_()}),u.addEventListener("input",()=>{if(p.value!=="__external__")return;const v=u.value.trim();a.link=v||null,b.className=`status-dot ${a.link?"active":""}`,I(e.slideIndex,a.elementIndex,a.link),S(),_()}),g.appendChild(y),g.appendChild(p),g.appendChild(x),f.appendChild(g)}),i.sidebarContent.appendChild(f)}function T(){const e=s.slides_state;if(!e||!Array.isArray(e.slides)){s.nodes=[],s.selectedNodeId=null,N(),w();return}s.nodes=e.slides.map((t,n)=>{t.arbre||(t.arbre={}),t.arbre.pos||(t.arbre.pos={});const l=t.arbre,r=100+n*260,d=120+n%4*160,m=l.pos.x,c=l.pos.y,f=typeof m=="number"?m:r,a=typeof c=="number"?c:d;l.pos.x=f,l.pos.y=a;const g=l.title||`Slide ${n+1}`,y=Array.isArray(t.elements)?t.elements:[];return{id:n+1,slideIndex:n,slideId:t.id,x:f,y:a,label:g,outputs:y.map((E,b)=>({elementIndex:b,elementId:E.id,name:E.type||"element",link:E.link??null}))}}),s.selectedNodeId!=null&&(s.nodes.some(n=>n.id===s.selectedNodeId)||(s.selectedNodeId=null)),N(),w()}function F(){try{const e=JSON.stringify(s.slides_state??{},null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),l=document.createElement("a");l.href=n,l.download="slides_state.json",document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(n)}catch(e){console.error("Export JSON failed:",e)}}function U(e){(e.target.id==="canvas"||e.target.classList.contains("help-text")||e.target.id==="nodes-layer"||e.target.id==="svg-layer")&&(s.selectedNodeId=null,N(),w())}function Z(e,t){if(e.button!==0)return;e.stopPropagation(),s.selectedNodeId=t,N(),w(),s.isDragging=!0,s.draggedNodeId=t;const n=s.nodes.find(l=>l.id===t);n&&(s.dragOffset.x=e.clientX-n.x,s.dragOffset.y=e.clientY-n.y)}function q(){i.canvasEl.addEventListener("mousedown",U),window.__ARBRE_START_DRAG__=Z,window.addEventListener("mousemove",e=>{if(!s.isDragging||s.draggedNodeId==null)return;const t=s.nodes.find(n=>n.id===s.draggedNodeId);t&&(t.x=e.clientX-s.dragOffset.x,t.y=e.clientY-s.dragOffset.y,G(t.slideIndex,t.x,t.y),N())}),window.addEventListener("mouseup",()=>{s.isDragging=!1,s.draggedNodeId=null})}const o={x:0,y:0,zoom:1,isPanning:!1,start:{x:0,y:0}},K=.2,V=2.5,W=.001;function A(){const e=`translate(${o.x}px, ${o.y}px) scale(${o.zoom})`;i.nodesLayer.style.transform=e,i.svgLayer.style.transform=e}function Q(){i.canvasEl.addEventListener("mousedown",e=>{s.isDragging||e.target!==i.canvasEl&&e.target!==i.nodesLayer&&e.target!==i.svgLayer||(o.isPanning=!0,o.start.x=e.clientX-o.x,o.start.y=e.clientY-o.y)}),window.addEventListener("mousemove",e=>{o.isPanning&&(o.x=e.clientX-o.start.x,o.y=e.clientY-o.start.y,A())}),window.addEventListener("mouseup",()=>{o.isPanning=!1}),i.canvasEl.addEventListener("wheel",e=>{e.preventDefault();const t=i.canvasEl.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,r=(n-o.x)/o.zoom,d=(l-o.y)/o.zoom,m=-e.deltaY*W,c=Math.min(V,Math.max(K,o.zoom*(1+m)));o.zoom=c,o.x=n-r*o.zoom,o.y=l-d*o.zoom,A(),N()},{passive:!1})}function ee(){R(),s.slides_state=B(),q(),i.btnAdd&&i.btnAdd.addEventListener("click",j),i.btnSave&&i.btnSave.addEventListener("click",()=>{k(),F()}),i.btnLoad&&i.btnLoad.addEventListener("click",()=>{const e="src/html/editor.html";window.location.href=`/Project_SlideLab/${e}`}),T(),Q(),A()}ee();
